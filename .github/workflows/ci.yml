name: CI

on:
  push:
    branches: [main]
    tags: ["*"]
  pull_request:
    branches: [main]

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install cyclonedx-bom

      - name: Run Ruff
        run: python -m ruff check src tests

      - name: Run mypy
        run: python -m mypy --strict src

      - name: Prepare artifact directory
        run: mkdir -p artifacts

      - name: Write mock service account
        run: |
          python - <<'PY'
          import json
          from pathlib import Path

          PRIVATE_KEY = """-----BEGIN PRIVATE KEY-----
          MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDRZQadZdopPLxU
          f5M1c5rc38WpKYhutDKkBSWcl50YBjL135XyCmcdRSWbEmovX0oIAgnD2jj+Iwai
          pYGa6ZfD1C6WgrkRt9cF87m/kz2AnmYmsrBVFL837ZjV2tVe/MmCv0vbNIu9WsFw
          /EGd7vBg3ZS+MqwCSVDw6QtkvuZ/Rq4L4WJ7mprofVLn+k9j6NJR4fKqNI1NpDkR
          SjV5o8Skl0iUXVEsKvMjCXRw6aJ1lLJkCwuthpEGgqCTUzXauFRiGde7kdkqsdl+
          fcGPXxmpTRWWL+md3kMLKp1cLcmWmMbo7PTnCV66iQ3pGkAteWlslXrjOYclvgq7
          2xQ+COK/AgMBAAECggEBAKX668RmUQkxEKP2QE01ZwNACeFuf6wpAJ9NSSQYdjjt
          6QVHBwfGQThNcGK8tRj58qfoXa820sh4ITFZ+iM+mMNs9MTvuB2YWURpjsqRv0Wt
          yZFRQT8f4/dESkryXQIfZOhUFKAcxcwCHaYe/zBej4JpAhfF+N0TGqrsP9DLFdC6
          WX44xvujG6kFg+5i8OxbkLMhWLU+LTt5T432S0jO1lCd5vox4FurdAdMLenM/ukJ
          3s/GGdLh8Uz+PdO3f3aCREr8t2zAnlDxvvWhDmchvshF/+t2Wx/4HytD3lC75OnA
          w1xK4sFgNHg2Il53gmT7EiZlZzKSAiM6qHSlMOb6wwkCgYEA89Y+ojqETtyye3Xa
          zpfFCqBcKZUyZN9VApZ4Gm8TMVEPi6jIcWRLz8CVa9IMzzuXvuYseLAxCiLdcIks
          3MF20tD4/8O2GyZLuyYA/dOYrkFMMlhxTGgwkBqRuP8suRTSAuRnZzZhF+emqKrx
          XX4Lx0HEo9ehzJWNtk0Pc5VdihUCgYEA29b1m5z6NiBG3M7OzViaPeaWCx99nA5h
          Sw1tQnlRpT3vX7ke1o7U/j6AzQSAThWFy4XtT4RH+CXQh436yhNtcH2N+Z+edp5s
          49Rt3Mf4jnkiSwLGnnq/M8Xw6VjtgJ5eqHmtNosqfhVTC22+hGl0XojIix29vTpi
          kQUbt9vO0oMCgYEA39enKgB0I31g8AuyMYOMJIQv9xB68bU/8h815HZhdR2IGtp4
          H/hFzFNsGE386mU3mcztuGFus3JsPHoBUCreLQwf+ZOt4mCWlxh9Qob0G8vf6jvc
          zpq7Mh7h9aVzZfjiDjulXU/DdFF5Yk+DQiOLJoGOxiYW55vHOzqk26Ob+j0CgYB9
          AaSzkfWtZXkmAesSVTmPzViwhn2UiZDFbqMcU4QbpDZDhi6E7r8quzveWJrky9RC
          wKsKtjt+XXJQQmnDEnz+pEZhFWS0Kq3cd2TpUESEL1lSsgdjAoVK2Vl+NvUGWAeX
          YWkfRM8q1tFcBFF7VcO4Jatzf7vuqA54TCFQ0QqwJQKBgEQZyL9Avj9ndT/QfJ1C
          SaySVQ/2U9+MXeSb+kxBqDnZqJ5hW4hZ7OWzeufCNZz1K85GTojAbYj/CKI3VSl9
          TwR5vWN73jj7ua5u7EgnRB9eP9fdCLWs6ixJHY4mvW4p1AY+QJJwSAPucJyaLzhW
          bYjRVYg7oxQtNQob+T3G6eAm
          -----END PRIVATE KEY-----"""

          payload = {
              "type": "service_account",
              "project_id": "test-project",
              "private_key_id": "mock-key-id",
              "private_key": PRIVATE_KEY,
              "client_email": "mock-sa@test-project.iam.gserviceaccount.com",
              "client_id": "12345678901234567890",
              "auth_uri": "https://accounts.google.com/o/oauth2/auth",
              "token_uri": "https://oauth2.googleapis.com/token",
              "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
              "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/mock-sa%40test-project.iam.gserviceaccount.com",
          }
          Path("/tmp/mock-sa.json").write_text(json.dumps(payload), encoding="utf-8")
          PY

      - name: Run pytest suite
        env:
          PROJECT_ID: test-project
          REGION: us
          DOC_AI_LOCATION: us
          DOC_AI_PROCESSOR_ID: processor-dummy
          DOC_AI_OCR_PROCESSOR_ID: processor-dummy
          DOC_AI_SPLITTER_PROCESSOR_ID: processor-split-dummy
          OPENAI_API_KEY: dummy-key
          DRIVE_INPUT_FOLDER_ID: drive-input
          DRIVE_REPORT_FOLDER_ID: drive-output
          INTAKE_GCS_BUCKET: intake-bucket
          OUTPUT_GCS_BUCKET: output-bucket
          SUMMARY_BUCKET: summary-bucket
          INTERNAL_EVENT_TOKEN: integration-token
          STUB_MODE: "true"
          USE_REFACTORED_SUMMARISER: "true"
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/mock-sa.json
          SERVICE_ACCOUNT_JSON: '{"type":"service_account","project_id":"test-project","client_email":"mock-sa@test-project.iam.gserviceaccount.com","token_uri":"https://oauth2.googleapis.com/token","private_key":"-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDRZQadZdopPLxU\nf5M1c5rc38WpKYhutDKkBSWcl50YBjL135XyCmcdRSWbEmovX0oIAgnD2jj+Iwai\npYGa6ZfD1C6WgrkRt9cF87m/kz2AnmYmsrBVFL837ZjV2tVe/MmCv0vbNIu9WsFw\n/EGd7vBg3ZS+MqwCSVDw6QtkvuZ/Rq4L4WJ7mprofVLn+k9j6NJR4fKqNI1NpDkR\nSjV5o8Skl0iUXVEsKvMjCXRw6aJ1lLJkCwuthpEGgqCTUzXauFRiGde7kdkqsdl+\nfcGPXxmpTRWWL+md3kMLKp1cLcmWmMbo7PTnCV66iQ3pGkAteWlslXrjOYclvgq7\n2xQ+COK/AgMBAAECggEBAKX668RmUQkxEKP2QE01ZwNACeFuf6wpAJ9NSSQYdjjt\n6QVHBwfGQThNcGK8tRj58qfoXa820sh4ITFZ+iM+mMNs9MTvuB2YWURpjsqRv0Wt\nyZFRQT8f4/dESkryXQIfZOhUFKAcxcwCHaYe/zBej4JpAhfF+N0TGqrsP9DLFdC6\nWX44xvujG6kFg+5i8OxbkLMhWLU+LTt5T432S0jO1lCd5vox4FurdAdMLenM/ukJ\n3s/GGdLh8Uz+PdO3f3aCREr8t2zAnlDxvvWhDmchvshF/+t2Wx/4HytD3lC75OnA\nw1xK4sFgNHg2Il53gmT7EiZlZzKSAiM6qHSlMOb6wwkCgYEA89Y+ojqETtyye3Xa\nzpfFCqBcKZUyZN9VApZ4Gm8TMVEPi6jIcWRLz8CVa9IMzzuXvuYseLAxCiLdcIks\n3MF20tD4/8O2GyZLuyYA/dOYrkFMMlhxTGgwkBqRuP8suRTSAuRnZzZhF+emqKrx\nXX4Lx0HEo9ehzJWNtk0Pc5VdihUCgYEA29b1m5z6NiBG3M7OzViaPeaWCx99nA5h\nSw1tQnlRpT3vX7ke1o7U/j6AzQSAThWFy4XtT4RH+CXQh436yhNtcH2N+Z+edp5s\n49Rt3Mf4jnkiSwLGnnq/M8Xw6VjtgJ5eqHmtNosqfhVTC22+hGl0XojIix29vTpi\nkQUbt9vO0oMCgYEA39enKgB0I31g8AuyMYOMJIQv9xB68bU/8h815HZhdR2IGtp4\nH/hFzFNsGE386mU3mcztuGFus3JsPHoBUCreLQwf+ZOt4mCWlxh9Qob0G8vf6jvc\nzpq7Mh7h9aVzZfjiDjulXU/DdFF5Yk+DQiOLJoGOxiYW55vHOzqk26Ob+j0CgYB9\nAaSzkfWtZXkmAesSVTmPzViwhn2UiZDFbqMcU4QbpDZDhi6E7r8quzveWJrky9RC\nwKsKtjt+XXJQQmnDEnz+pEZhFWS0Kq3cd2TpUESEL1lSsgdjAoVK2Vl+NvUGWAeX\nYWkfRM8q1tFcBFF7VcO4Jatzf7vuqA54TCFQ0QqwJQKBgEQZyL9Avj9ndT/QfJ1C\nSaySVQ/2U9+MXeSb+kxBqDnZqJ5hW4hZ7OWzeufCNZz1K85GTojAbYj/CKI3VSl9\nTwR5vWN73jj7ua5u7EgnRB9eP9fdCLWs6ixJHY4mvW4p1AY+QJJwSAPucJyaLzhW\nbYjRVYg7oxQtNQob+T3G6eAm\n-----END PRIVATE KEY-----\n"}'
        run: python -m pytest --cov=src -q --cov-report=term --cov-report=xml

      - name: Run summary validator
        run: >
          python scripts/validate_summary.py
          --pdf-path tests/fixtures/validator_sample.pdf
          --expected-pages 1
          --summary-json tests/fixtures/summary_with_claims.json

      - name: Move coverage report
        run: |
          if [ -f coverage.xml ]; then
            mv coverage.xml artifacts/coverage.xml
          fi

      - name: Generate SBOM (CycloneDX)
        run: python -m cyclonedx_py requirements --format json --output artifacts/sbom.json --file requirements.txt

      - name: Prepare redacted validator artifact
        run: |
          cat <<'JSON' > artifacts/validator-redacted.json
          {"ok": null, "sections_ok": null, "noise_found": null, "length": null}
          JSON

      - name: Upload PR artifacts
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: ci-artifacts
          path: artifacts/
          if-no-files-found: ignore

      - name: pip-audit (report only)
        if: github.event_name == 'pull_request'
        run: pip-audit -r requirements.txt || true

      - name: pip-audit (enforced)
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
        run: pip-audit -r requirements.txt

  trivy-report:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955

      - name: Trivy filesystem scan (report only)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          scan-type: fs
          scan-ref: .
          ignore-unfixed: true
          exit-code: "0"
          severity: "CRITICAL,HIGH,MEDIUM"
          format: "table"

  trivy:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955

      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          scan-type: fs
          scan-ref: .
          ignore-unfixed: true
          exit-code: "1"
          severity: "CRITICAL,HIGH"
          format: "table"
